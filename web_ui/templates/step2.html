<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Clone Step 2: Character Refinement</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;family=Noto+Sans:wght@400;500&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "lab-bg": "#0D1117",
                        "lab-border": "#30363D",
                        "lab-blue": "#00A3FF",
                        "lab-green": "#A6FF00",
                        "lab-card": "#161B22",
                        "lab-muted": "#8B949E",
                        "background-light": "#FFFFFF",
                        "background-dark": "#0D1117",
                        "primary": "#00A3FF"
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
        }
        /* Custom Scrollbar for the Grid Area */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0D1117; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #30363D; 
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #00A3FF; 
        }
        
        .scan-line {
            background: linear-gradient(to bottom, transparent 0%, #A6FF0022 50%, transparent 100%);
            height: 20px;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 h-screen overflow-hidden flex flex-col">
    
    <!-- Top Navigation (Fixed Height: h-16) -->
    <header class="border-b border-lab-border bg-lab-bg/95 backdrop-blur-sm z-50 shrink-0 h-16">
        <div class="max-w-[1400px] mx-auto px-8 h-full flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 flex items-center justify-center">
                    <img src="/static/mohen.svg" class="w-8 h-8" alt="MoHen Logo" />
                </div>
                <div class="flex flex-col leading-none">
                    <h1 class="text-[11px] font-black tracking-[0.25em] text-white uppercase">Handwriting Lab</h1>
                    <span class="text-[9px] font-bold text-lab-blue tracking-widest uppercase">Version 1.2</span>
                </div>
            </div>
            <div class="flex items-center h-full gap-8">
                <nav class="flex h-full">
                    <a class="px-6 flex items-center text-[11px] font-bold uppercase tracking-[0.2em] text-lab-blue border-b-2 border-lab-blue h-full" href="/">Clone</a>
                    <a class="px-6 flex items-center text-[11px] font-bold uppercase tracking-[0.2em] text-lab-muted hover:text-white transition-colors h-full" href="/generate">Generate</a>
                </nav>
                <div class="hidden flex items-center gap-5 border-l border-lab-border pl-8">
                    <div class="w-8 h-8 rounded border border-lab-border bg-lab-card flex items-center justify-center">
                        <span class="material-symbols-outlined text-sm text-lab-muted">person</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Steps Navigation (Fixed Height: h-12) -->
    <div class="bg-lab-card/30 border-b border-lab-border shrink-0 h-12">
        <div class="max-w-[1400px] mx-auto px-8 h-full flex items-center gap-12">
            <a href="/" class="flex items-center gap-3 text-[10px] font-bold uppercase tracking-[0.15em] text-lab-muted hover:text-white transition-colors">
                <span class="w-5 h-5 flex items-center justify-center border border-lab-border rounded-full text-[9px] leading-none">1</span>
                PREPARE
            </a>
            <div class="flex items-center gap-3 text-[10px] font-bold uppercase tracking-[0.15em] text-lab-blue">
                <span class="w-5 h-5 flex items-center justify-center border border-lab-blue rounded-full text-[9px] leading-none">2</span>
                REFINE
            </div>
            <div class="flex items-center gap-3 text-[10px] font-bold uppercase tracking-[0.15em] text-lab-muted">
                <span class="w-5 h-5 flex items-center justify-center border border-lab-border rounded-full text-[9px] leading-none">3</span>
                TRAINING
            </div>
        </div>
    </div>

    <!-- Main Content (Flex-1 to fill remaining height) -->
    <main class="flex-1 max-w-[1400px] mx-auto w-full px-8 py-6 flex flex-col min-h-0">
        
        <!-- Header (Split Layout) -->
        <div class="flex items-end justify-between mb-6 pb-6 border-b border-lab-border/30 shrink-0">
            <div class="flex-1 pr-12 border-r border-lab-border/30">
                <div class="flex items-center gap-2 mb-2">
                    <div class="h-[1px] w-8 bg-lab-blue"></div>
                    <p class="text-lab-blue text-[10px] font-bold tracking-[0.4em] uppercase">PHASE 02: ANALYSIS & REFINEMENT</p>
                </div>
                <h2 class="text-3xl font-bold text-white tracking-tight">Specimen Refinement</h2>
            </div>
            <div class="flex-1 pl-12 flex flex-col justify-end h-full">
                 <p class="text-lab-muted text-sm leading-relaxed">
                    AI extraction complete. Our neural engine has segmented <span class="text-primary font-mono" id="char-count">0</span> unique characters. 
                    Inspect the specimens below to calibrate extraction bounds for high-fidelity cloning.
                </p>
            </div>
        </div>

        <!-- Main Canvas Area (Flex-1 to take available space, Internal Scroll) -->
        <div class="relative bg-black/20 rounded-xl border border-lab-border p-6 flex-1 flex flex-col min-h-0 overflow-hidden">
            
            <!-- Grid Controls -->
            <div class="flex items-center justify-between mb-4 shrink-0">
                <div class="flex gap-4">
                    <!-- Filters removed as requested -->
                </div>
                <div class="text-xs font-mono text-lab-muted uppercase tracking-widest flex items-center gap-2">
                    <span class="size-2 bg-lab-blue rounded-full animate-pulse"></span>
                    Neural Grid Synchronized
                </div>
            </div>

            <!-- Scrollable Character Grid -->
            <div class="overflow-y-auto pr-2 custom-scrollbar flex-1">
                <div id="grid-container" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3 pb-4">
                    <!-- Characters will be injected here by JS -->
                </div>
            </div>
        </div>

        <!-- Footer (Compact Integration) -->
        <div class="flex items-center justify-between pt-2 shrink-0">
            <button onclick="window.location.href='/'" class="px-6 py-3 border border-lab-border rounded-lg text-lab-muted font-bold tracking-widest uppercase text-xs hover:border-slate-600 hover:text-white transition-all">
                Back to Upload
            </button>
            <div class="flex items-center gap-6">
                <!-- Integrated Stats -->
                <div class="flex items-center gap-4 border-r border-lab-border pr-6 hidden md:flex">
                     <div class="text-right">
                        <p class="text-[9px] font-mono text-lab-muted uppercase">Quality</p>
                        <p class="text-sm font-bold text-lab-green">88.4%</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-mono text-lab-muted uppercase">Est. Time</p>
                        <p class="text-sm font-bold text-white">14m 32s</p>
                    </div>
                </div>

                <button id="next-btn" onclick="window.location.href='/step3'" class="flex items-center gap-3 px-8 py-3 bg-lab-green text-lab-bg rounded-lg font-black tracking-[0.1em] uppercase hover:scale-[1.02] active:scale-[0.98] transition-all shadow-[0_0_20px_-5px_#A6FF00] text-sm disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-600 disabled:text-gray-400 disabled:shadow-none">
                    Confirm & Start
                    <span class="material-symbols-outlined text-lg">rocket_launch</span>
                </button>
            </div>
        </div>
    </main>
    
    <!-- Editor Modal -->
    <div id="editor-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-lab-card border border-lab-border rounded-xl w-[90vw] h-[90vh] flex flex-col shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300" id="modal-content">
            <!-- Header -->
            <div class="h-14 border-b border-lab-border flex items-center justify-between px-6 bg-lab-bg">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-lab-blue">crop</span>
                    <h3 class="font-bold text-white uppercase tracking-wider text-sm">Fine-tune Character: <span id="modal-char" class="text-lab-green"></span></h3>
                </div>
                <div class="flex gap-4">
                    <button id="modal-cancel" class="text-xs font-bold text-lab-muted hover:text-white uppercase tracking-wider">Cancel</button>
                    <button id="modal-save" class="bg-lab-blue text-black px-6 py-2 rounded font-bold text-xs uppercase tracking-wider hover:brightness-110 transition-all">Save Changes</button>
                </div>
            </div>
            
            <!-- Editor Area -->
            <div class="flex-1 relative bg-black/50 overflow-hidden flex items-center justify-center select-none" id="editor-canvas-container">
                <!-- Image Wrapper -->
                <!-- Use inline-block or flex to wrap content -->
                <div id="image-wrapper" class="relative shadow-2xl origin-center">
                    <img id="grid-image" src="" class="max-w-none pointer-events-none select-none block" draggable="false" />
                    <!-- Crop Box (Fixed Position for Step 1) -->
                     <div id="crop-box" class="absolute border-2 border-lab-green shadow-[0_0_10px_rgba(166,255,0,0.5)] box-content group" style="display: none;">
                        <!-- Handles -->
                        <div class="absolute -top-1.5 -left-1.5 w-3 h-3 bg-lab-green border border-black cursor-nw-resize"></div>
                        <div class="absolute -top-1.5 -right-1.5 w-3 h-3 bg-lab-green border border-black cursor-ne-resize"></div>
                        <div class="absolute -bottom-1.5 -left-1.5 w-3 h-3 bg-lab-green border border-black cursor-sw-resize"></div>
                        <div class="absolute -bottom-1.5 -right-1.5 w-3 h-3 bg-lab-green border border-black cursor-se-resize"></div>
                        <!-- Center Crosshair -->
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-lab-green/50 rounded-full pointer-events-none"></div>
                    </div>
                </div>
            </div>
            

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentData = [];
            let currentIdx = -1;
            let currentScale = 1;
            
            const modal = document.getElementById('editor-modal');
            const modalContent = document.getElementById('modal-content');
            const gridImage = document.getElementById('grid-image');
            const cropBox = document.getElementById('crop-box');
            const imageWrapper = document.getElementById('image-wrapper');
            const container = document.getElementById('editor-canvas-container');
            
            // Fetch Data
            fetch('/api/characters')
                .then(response => response.json())
                .then(data => {
                    currentData = data;
                    renderGrid(data);
                });

            // Check training status and redirect if needed
            fetch('/api/training_status')
                .then(res => res.json())
                .then(data => {
                    if (data.state === 'training' || data.state === 'preparing') {
                        window.location.href = '/step3';
                    }
                });

            function renderGrid(data) {
                const container = document.getElementById('grid-container');
                const countEl = document.getElementById('char-count');
                const nextBtn = document.getElementById('next-btn');
                
                if (!data || data.length === 0) {
                    countEl.textContent = "0";
                    container.innerHTML = `<div class="col-span-full text-center text-lab-muted py-10">No characters detected. Please go back to Step 1 and upload a valid template.</div>`;
                    
                    // Disable Next Button
                    nextBtn.disabled = true;
                    nextBtn.innerHTML = 'No Data <span class="material-symbols-outlined text-lg">block</span>';
                    nextBtn.title = "Please upload a valid template in Step 1";
                    return;
                }
                
                // Enable Next Button
                nextBtn.disabled = false;
                nextBtn.innerHTML = 'Confirm & Start <span class="material-symbols-outlined text-lg">rocket_launch</span>';
                nextBtn.title = "";
                
                countEl.textContent = data.length;
                container.innerHTML = ''; // Clear existing
                
                data.forEach((char, idx) => {
                    const div = document.createElement('div');
                    div.className = "group relative bg-white/5 border border-lab-border rounded-lg aspect-square flex items-center justify-center cursor-pointer hover:border-lab-blue/50 transition-all overflow-hidden";
                    div.onclick = () => openEditor(idx);
                    
                    // Use real image if URL is present
                    const timestamp = new Date().getTime();
                    const url = char.url.includes('?') ? char.url : `${char.url}?t=${timestamp}`;
                    
                    if (char.url) {
                        div.innerHTML = `
                            <div class="absolute inset-0 bg-lab-blue/5 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white font-bold text-xs bg-black/50 px-2 py-1 rounded backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity">EDIT</span>
                            </div>
                            <img src="${url}" alt="${char.char}" class="w-full h-full object-cover group-hover:scale-105 transition-transform" />
                            <div class="absolute top-1 left-1 text-[10px] font-bold text-white bg-black/50 px-1 rounded z-20">${char.char}</div>
                        `;
                    }
                    container.appendChild(div);
                });
            }

            // Editor Logic
            function openEditor(idx) {
                currentIdx = idx;
                const target = currentData[idx]; 
                
                document.getElementById('modal-char').textContent = target.char;
                
                // Load Grid Image
                const timestamp = new Date().getTime();
                gridImage.src = `/sliced_images/grid_warped.jpg?t=${timestamp}`;
                
                // Reset Transforms
                imageWrapper.style.transform = 'none';
                
                gridImage.onload = () => {
                     // For Step 2: Position box according to backend data
                     
                     // 1. Get BBox from data
                     const bbox = target.bbox || [0,0,100,100];
                     
                     // 2. Set Crop Box Position directly (without centering view/scaling logic yet)
                     // Keep scale at 0.5 to see everything clearly for verification
                     currentScale = 0.5;
                     
                     // Reset View to top-left (no pan)
                     currentTx = 0;
                     currentTy = 0;
                     
                     // Apply Position
                      // Make sure to show it
                      cropBox.style.display = 'block';
                      setBox(bbox[0], bbox[1], bbox[2], bbox[3]);
                     
                     updateTransform();
                     
                     modal.classList.remove('hidden');
                     void modal.offsetWidth;
                     modal.classList.remove('opacity-0');
                     modalContent.classList.remove('scale-95');
                };
            }
            
            function closeEditor() {
                modal.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
            
            document.getElementById('modal-cancel').onclick = closeEditor;
            
            // Box Manipulation
            let isDragging = false;
            let resizeMode = null; // 'nw', 'ne', 'sw', 'se'
            let isPanning = false;
            let startX, startY;
            let startBox = {};
            let startTx, startTy;
            let currentTx = 0, currentTy = 0;
            
            function setBox(x, y, w, h) {
                cropBox.style.left = x + 'px';
                cropBox.style.top = y + 'px';
                cropBox.style.width = w + 'px';
                cropBox.style.height = h + 'px';
            }
            
            // Image Panning
            container.addEventListener('mousedown', (e) => {
                if (e.target === container || e.target === imageWrapper || e.target === gridImage) {
                    isPanning = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startTx = currentTx;
                    startTy = currentTy;
                    container.style.cursor = 'grabbing';
                }
            });
            
            cropBox.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                startX = e.clientX;
                startY = e.clientY;
                startBox = {
                    x: parseFloat(cropBox.style.left),
                    y: parseFloat(cropBox.style.top),
                    w: parseFloat(cropBox.style.width),
                    h: parseFloat(cropBox.style.height)
                };
                
                if (e.target.classList.contains('cursor-nw-resize')) resizeMode = 'nw';
                else if (e.target.classList.contains('cursor-ne-resize')) resizeMode = 'ne';
                else if (e.target.classList.contains('cursor-sw-resize')) resizeMode = 'sw';
                else if (e.target.classList.contains('cursor-se-resize')) resizeMode = 'se';
                else {
                    resizeMode = null;
                    isDragging = true;
                }
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            
            function onMouseMove(e) {
                if (isPanning) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    currentTx = startTx + dx;
                    currentTy = startTy + dy;
                    updateTransform();
                    return;
                }
                
                // Calculate delta in Image Space
                const dx = (e.clientX - startX) / currentScale;
                const dy = (e.clientY - startY) / currentScale;
                
                if (isDragging) {
                    setBox(startBox.x + dx, startBox.y + dy, startBox.w, startBox.h);
                } else if (resizeMode) {
                    let nx = startBox.x;
                    let ny = startBox.y;
                    let nw = startBox.w;
                    let nh = startBox.h;
                    
                    if (resizeMode.includes('e')) nw = startBox.w + dx;
                    if (resizeMode.includes('s')) nh = startBox.h + dy;
                    if (resizeMode.includes('w')) {
                        nx = startBox.x + dx;
                        nw = startBox.w - dx;
                    }
                    if (resizeMode.includes('n')) {
                        ny = startBox.y + dy;
                        nh = startBox.h - dy;
                    }
                    
                    if (nw > 10 && nh > 10) {
                        setBox(nx, ny, nw, nh);
                    }
                }
            }
            
            function onMouseUp() {
                isDragging = false;
                resizeMode = null;
                isPanning = false;
                container.style.cursor = 'default';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                currentScale *= delta;
                updateTransform();
            });
            
            function updateTransform() {
                imageWrapper.style.transform = `translate(${currentTx}px, ${currentTy}px) scale(${currentScale})`;
                imageWrapper.style.transformOrigin = "center center"; 
            }

            // Save (Disabled for Step 1)// Save
            document.getElementById('modal-save').onclick = () => {
                const item = currentData[currentIdx];
                const x = Math.round(parseFloat(cropBox.style.left));
                const y = Math.round(parseFloat(cropBox.style.top));
                const w = Math.round(parseFloat(cropBox.style.width));
                const h = Math.round(parseFloat(cropBox.style.height));
                
                const payload = {
                    index: item.index,
                    x: x, y: y, w: w, h: h
                };
                
                document.getElementById('modal-save').textContent = "Saving...";
                
                fetch('/api/update_slice', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                })
                .then(res => res.json())
                .then(res => {
                    // Update local data
                    item.bbox = [x, y, w, h];
                    item.url = res.url;
                    renderGrid(currentData);
                    closeEditor();
                    document.getElementById('modal-save').textContent = "Save Changes";
                });
            };
        });
    </script>
</body>
</html>