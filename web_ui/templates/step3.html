<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Clone Step 3: Training &amp; Naming</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;family=Noto+Sans+SC:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "lab-bg": "#0D1117",
                        "lab-border": "#30363D",
                        "lab-blue": "#00A3FF",
                        "lab-green": "#A6FF00",
                        "lab-card": "#161B22",
                        "lab-muted": "#8B949E",
                        "background-light": "#FFFFFF",
                        "background-dark": "#0D1117",
                        "primary": "#00A3FF"
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "sans": ["Space Grotesk", "Noto Sans SC", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif;
        }
        .terminal-scroll {
            scrollbar-width: thin;
            scrollbar-color: #333 #000;
        }
        /* Ensure high contrast for logs */
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-bottom: 4px;
            word-break: break-all;
            line-height: 1.4;
        }
        .log-ts { color: #888; margin-right: 8px; user-select: none; }
        .log-msg { color: #4ade80; } /* Bright Green */
        
        @keyframes reverse-spin {
            from { transform: rotate(360deg); }
            to { transform: rotate(0deg); }
        }
        .animate-reverse-spin {
            animation: reverse-spin linear infinite;
        }
    </style>
</head>
<body class="bg-[#0d1117] text-slate-100 h-screen overflow-hidden flex flex-col">
    <!-- Top Navigation (Fixed Height: h-16) -->
    <header class="border-b border-lab-border bg-lab-bg/95 backdrop-blur-sm z-50 shrink-0 h-16">
        <div class="max-w-[1400px] mx-auto px-8 h-full flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 flex items-center justify-center bg-lab-blue/10 rounded border border-lab-blue/30">
                    <img src="/static/mohen.svg" class="w-5 h-5" alt="MoHen Logo" />
                </div>
                <div class="flex flex-col leading-none">
                    <h1 class="text-[11px] font-black tracking-[0.25em] text-white uppercase">Handwriting Lab</h1>
                    <span class="text-[9px] font-bold text-lab-blue tracking-widest uppercase">Version 1.2</span>
                </div>
            </div>
            
            <!-- Training Status Banner (Replaces Navigation) -->
            <div class="flex items-center h-full gap-8" id="nav-container">
                <div id="training-banner" class="hidden items-center gap-3 px-4 py-2 bg-lab-blue/10 border border-lab-blue/30 rounded-full animate-pulse">
                    <span class="w-2 h-2 rounded-full bg-lab-blue"></span>
                    <span class="text-[10px] font-bold uppercase tracking-widest text-lab-blue">Training in Progress - Do Not Close</span>
                </div>
                
                <nav class="flex h-full" id="main-nav">
                    <a class="px-6 flex items-center text-[11px] font-bold uppercase tracking-[0.2em] text-lab-blue border-b-2 border-lab-blue h-full" href="/">Clone</a>
                    <a class="px-6 flex items-center text-[11px] font-bold uppercase tracking-[0.2em] text-lab-muted hover:text-white transition-colors h-full" href="/generate">Generate</a>
                </nav>
                <div class="flex items-center gap-5 border-l border-lab-border pl-8">
                    <div class="w-8 h-8 rounded border border-lab-border bg-lab-card flex items-center justify-center">
                        <span class="material-symbols-outlined text-sm text-lab-muted">person</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Steps Navigation (Fixed Height: h-12) -->
    <div class="bg-lab-card/30 border-b border-lab-border shrink-0 h-12" id="steps-nav">
        <div class="max-w-[1400px] mx-auto px-8 h-full flex items-center gap-12">
            <!-- Steps are read-only anchors/divs now -->
            <div class="flex items-center gap-3 text-[10px] font-bold uppercase tracking-[0.15em] text-lab-muted opacity-50 cursor-not-allowed">
                <span class="w-5 h-5 flex items-center justify-center border border-lab-border rounded-full text-[9px] leading-none">1</span>
                PREPARE
            </div>
            <div class="flex items-center gap-3 text-[10px] font-bold uppercase tracking-[0.15em] text-lab-muted opacity-50 cursor-not-allowed">
                <span class="w-5 h-5 flex items-center justify-center border border-lab-border rounded-full text-[9px] leading-none">2</span>
                REFINE
            </div>
            <div class="flex items-center gap-3 text-[10px] font-bold uppercase tracking-[0.15em] text-lab-blue">
                <span class="w-5 h-5 flex items-center justify-center border border-lab-blue rounded-full text-[9px] leading-none">3</span>
                TRAINING
            </div>
        </div>
    </div>

    <!-- Main Content (Flex-1 to fill remaining height) -->
    <main class="flex-1 max-w-[1400px] mx-auto w-full px-8 py-6 flex flex-col min-h-0">
        
        <!-- Header (Split Layout) -->
        <div class="flex items-end justify-between mb-6 pb-6 border-b border-lab-border/30 shrink-0">
            <div class="flex-1 pr-12 border-r border-lab-border/30">
                <div class="flex items-center gap-2 mb-2">
                    <div class="h-[1px] w-8 bg-lab-blue"></div>
                    <p class="text-lab-blue text-[10px] font-bold tracking-[0.4em] uppercase">PHASE 03: NEURAL SYNTHESIS</p>
                </div>
                <h2 class="text-3xl font-bold text-white tracking-tight">Model Training</h2>
            </div>
            <div class="flex-1 pl-12 flex flex-col justify-end h-full">
                 <p class="text-lab-muted text-sm leading-relaxed">
                    Synthesizing your unique handwriting profile in the neural laboratory. This usually takes 2-3 minutes.
                </p>
            </div>
        </div>

        <!-- Main Content Area: Split Layout (Flex-1) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center flex-1 min-h-0">
            <!-- Left Column: Circular Progress -->
            <div class="flex flex-col items-center justify-center h-full">
                <div class="relative w-80 h-80 flex items-center justify-center">
                    <!-- Outer Rings -->
                    <div class="absolute inset-0 border-2 border-lab-blue/10 rounded-full animate-spin" style="animation-duration: 10s;"></div>
                    <div class="absolute inset-4 border border-lab-blue/20 rounded-full animate-reverse-spin" style="animation-duration: 8s;"></div>
                    <!-- Progress Ring SVG -->
                    <svg class="absolute inset-0 w-full h-full -rotate-90 transform" viewBox="0 0 100 100">
                        <circle class="text-lab-border" cx="50" cy="50" fill="transparent" r="46" stroke="currentColor" stroke-width="2"></circle>
                        <circle id="progress-circle" class="text-lab-blue transition-all duration-300 ease-out" cx="50" cy="50" fill="transparent" r="46" stroke="currentColor" stroke-dasharray="289.02652413026095" stroke-dashoffset="289.02652413026095" stroke-linecap="round" stroke-width="2"></circle>
                    </svg>
                    <!-- Central Ink Animation Container -->
                    <div class="relative w-56 h-56 bg-[#0d1117] rounded-full border border-lab-blue/30 flex items-center justify-center overflow-hidden shadow-[0_0_30px_rgba(0,163,255,0.2)]">
                        <div class="w-full h-full flex items-center justify-center flex-col z-10">
                            <span id="progress-text" class="text-5xl font-bold text-white mb-1">0%</span>
                            <span id="status-text" class="text-xs font-mono text-lab-blue tracking-widest uppercase animate-pulse">WAITING</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Terminal or Completion Card -->
            <div class="relative h-full max-h-[500px] flex flex-col justify-center">
                <!-- Terminal (Visible during training) -->
                <div class="absolute inset-0 transition-opacity duration-500 opacity-100 z-10 flex flex-col" id="terminal-view">
                    <div class="flex items-center justify-between mb-4 shrink-0">
                        <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wider text-lab-muted">
                            <span class="material-symbols-outlined text-sm">terminal</span>
                            System Details
                        </div>
                        <!-- Status Indicator -->
                        <div class="flex items-center gap-2">
                             <div id="status-dot" class="w-2 h-2 rounded-full bg-lab-muted"></div>
                             <span id="status-label" class="text-[10px] font-mono text-lab-muted uppercase">IDLE</span>
                        </div>
                    </div>
                    <!-- Terminal Content with forced high contrast -->
                    <div id="terminal-content" class="rounded-lg border border-gray-700 shadow-inner flex-1 terminal-scroll overflow-y-auto relative" style="background-color: #000000; padding: 16px;">
                        <div id="logs-container" style="position: relative; z-index: 10;">
                            <div style="color: #666; text-align: center; padding-top: 40px;">
                                Ready to initialize training sequence.<br>
                                Click START to begin.
                            </div>
                        </div>
                    </div>
                    <!-- Start Button (Overlay) - REMOVED for auto-start -->
                    <!-- <div id="start-overlay" ...> -->
                </div>

                <!-- Completion Card (Initially Hidden) -->
                <div id="completion-card" class="hidden absolute inset-0 bg-lab-dark/90 backdrop-blur-sm flex items-center justify-center z-50">
                    <div class="bg-lab-gray border border-lab-light-gray p-8 rounded-lg shadow-2xl max-w-md w-full text-center relative">
                        <!-- Close/Hide Log Button -->
                        <button onclick="document.getElementById('completion-card').classList.add('hidden')" class="absolute top-2 right-2 text-lab-muted hover:text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        
                        <div class="mb-6">
                            <div class="w-16 h-16 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">Training Complete!</h3>
                            <p class="text-lab-muted text-sm">Your custom font model is ready.</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-left text-xs font-bold text-lab-muted uppercase tracking-wider mb-2">Name Your Style</label>
                                <!-- Fixed Input Style: explicit colors with !important just in case -->
                                <input type="text" id="font-name-input" placeholder="e.g., My Calligraphy" class="w-full !bg-gray-800 !text-white border border-gray-600 rounded px-4 py-3 focus:border-lab-blue focus:outline-none transition-colors placeholder-gray-500">
                            </div>
                            
                            <div class="flex gap-3">
                                <!-- Fixed function name match and type -->
                                <button type="button" onclick="saveFontName()" class="flex-1 bg-lab-blue hover:bg-blue-600 text-white font-bold py-3 px-4 rounded transition-colors shadow-lg">
                                    Save & Continue
                                </button>
                            </div>
                            
                            <div class="pt-4 border-t border-lab-light-gray/30">
                                <button onclick="document.getElementById('completion-card').classList.add('hidden')" class="text-xs text-lab-muted hover:text-white underline">
                                    View Training Logs
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Integrated Footer -->
        <div class="flex items-center justify-between pt-2 shrink-0 border-t border-lab-border/30 mt-4">
            <div class="flex items-center gap-10">
                <div class="flex items-center gap-2">
                    <div class="w-1.5 h-1.5 bg-lab-green rounded-full shadow-[0_0_8px_#A6FF00]"></div>
                    <span class="text-[9px] font-bold uppercase tracking-[0.2em] text-white">Neural Core Active</span>
                </div>
                <div class="text-[9px] font-bold uppercase tracking-[0.2em] text-lab-muted flex items-center gap-2 hidden sm:flex">
                    <span class="material-symbols-outlined text-[14px]">memory</span>
                    GPU Clusters: [4/4] Nominal
                </div>
            </div>
            <div class="text-[9px] font-bold uppercase tracking-[0.3em] text-lab-muted/50 hidden sm:block">
                HS-LAB_PROTOCOL_V1.2 // SECURE_UPLINK
            </div>
        </div>
    </main>

    <script>
        // DOM Elements - Defined at top level
        const progressCircle = document.getElementById('progress-circle');
        const progressText = document.getElementById('progress-text');
        const logsContainer = document.getElementById('logs-container');
        const circumference = 2 * Math.PI * 46;
        const terminalView = document.getElementById('terminal-view');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const statusLabel = document.getElementById('status-label');
        const fontNameInput = document.getElementById('font-name-input');
        const trainingBanner = document.getElementById('training-banner');
        const mainNav = document.getElementById('main-nav');
        
        let isPolling = false;

        // Initialize Progress Circle
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = circumference;

        function setTrainingMode(active) {
            if (active) {
                if (mainNav) mainNav.classList.add('hidden');
                if (trainingBanner) {
                    trainingBanner.classList.remove('hidden');
                    trainingBanner.classList.add('flex');
                }
                window.onbeforeunload = function() {
                    return "Training is in progress.";
                };
            } else {
                if (mainNav) mainNav.classList.remove('hidden');
                if (trainingBanner) {
                    trainingBanner.classList.add('hidden');
                    trainingBanner.classList.remove('flex');
                }
                window.onbeforeunload = null;
            }
        }

        function saveFontName() {
            const name = fontNameInput.value.trim() || "My Custom Font";
            fetch('/api/save_font_name', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name: name })
            })
            .then(() => window.location.href = '/generate')
            .catch(err => {
                console.error("Failed to save name:", err);
                window.location.href = '/generate';
            });
        }

        function updateProgress(percent) {
            percent = Number(percent);
            const offset = circumference - (percent / 100) * circumference;
            progressCircle.style.strokeDashoffset = offset;
            progressText.textContent = Math.round(percent) + "%";
            
            // UI Updates based on percent
            if (percent > 0 && percent < 100) {
                if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse";
                if (statusLabel) {
                    statusLabel.textContent = "RUNNING";
                    statusLabel.style.color = "#3b82f6";
                }
                if (statusText) {
                    statusText.textContent = "TRAINING";
                    statusText.style.color = "#3b82f6";
                }
            } else if (percent === 100) {
                if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-green-500";
                if (statusLabel) {
                    statusLabel.textContent = "DONE";
                    statusLabel.style.color = "#22c55e";
                }
                if (statusText) {
                    statusText.textContent = "COMPLETE";
                    statusText.style.color = "#22c55e";
                }
            }
        }

        function completeTraining() {
            setTrainingMode(false);
            if (statusText) {
                statusText.textContent = "COMPLETE";
                statusText.classList.remove('animate-pulse');
                statusText.classList.add('text-lab-green');
            }
            if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-lab-green";
            if (statusLabel) {
                statusLabel.textContent = "COMPLETED";
                statusLabel.className = "text-[10px] font-mono text-lab-green uppercase";
            }
            
            setTimeout(() => {
                const card = document.getElementById('completion-card');
                if (card) {
                    card.classList.remove('hidden');
                    card.classList.add('animate-fade-in');
                }
            }, 500);
        }

        function startTraining() {
            if (logsContainer) logsContainer.innerHTML = '';
            
            fetch('/api/train', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.message === "Training started" || data.message === "Training already in progress") {
                    startPolling();
                } else {
                    if (statusText) {
                        statusText.textContent = "ERROR";
                        statusText.classList.add('text-red-500');
                    }
                    if (data.message.includes("No training data found")) {
                        alert(data.message);
                    }
                }
            })
            .catch(err => console.error(err));
        }

        function startPolling() {
            if (isPolling) return;
            isPolling = true;
            setTrainingMode(true);
            
            function fetchStatus() {
                fetch('/api/training_status')
                    .then(res => res.json())
                    .then(data => {
                        updateProgress(data.progress);
                        
                        // Handle Logs
                        if (data.log && data.log.length > 0 && logsContainer) {
                             logsContainer.innerHTML = ''; 
                             data.log.forEach(log => {
                                const div = document.createElement('div');
                                div.className = "log-entry";
                                const ts = new Date().toLocaleTimeString().split(' ')[0];
                                div.innerHTML = `<span class="log-ts">[${ts}]</span><span class="log-msg">${log}</span>`;
                                logsContainer.appendChild(div);
                            });
                            logsContainer.parentElement.scrollTop = logsContainer.parentElement.scrollHeight;
                        } else if (logsContainer && logsContainer.children.length === 0) {
                            logsContainer.innerHTML = '<div style="color: #666; text-align: center; margin-top: 20px;">Waiting for logs...</div>';
                        }
                        
                        // Force update status text
                        if (data.state === 'training' || data.state === 'preparing') {
                             if (statusText) {
                                 statusText.textContent = "TRAINING";
                                 statusText.style.color = "#3b82f6";
                             }
                             if (statusLabel) {
                                 statusLabel.textContent = "RUNNING";
                                 statusLabel.style.color = "#3b82f6";
                             }
                             if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse";
                        }

                        if (data.state === 'completed') {
                            clearInterval(interval);
                            isPolling = false;
                            updateProgress(100);
                            completeTraining();
                        } else if (data.state === 'failed') {
                            clearInterval(interval);
                            isPolling = false;
                            if (statusText) {
                                statusText.textContent = "FAILED";
                                statusText.classList.add('text-red-500');
                            }
                            if (logsContainer) {
                                const div = document.createElement('div');
                                div.className = "log-entry";
                                div.innerHTML = `<span class="log-ts">[ERR]</span><span style="color:red">${data.error || 'Unknown Error'}</span>`;
                                logsContainer.appendChild(div);
                            }
                        }
                    })
                    .catch(err => console.error(err));
            }

            // Initial call and interval
            fetchStatus();
            const interval = setInterval(fetchStatus, 1000);
        }
        
        // Auto-start logic on load
        fetch('/api/training_status')
            .then(res => res.json())
            .then(data => {
                if (data.state === 'training' || data.state === 'preparing') {
                    startPolling();
                } else if (data.state === 'completed') {
                    updateProgress(100);
                    completeTraining();
                } else if (data.state === 'idle') {
                    startTraining();
                }
            });
    </script>
</body>
</html>